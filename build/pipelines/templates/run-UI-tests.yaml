# This template contains jobs to run UI tests using WinAppDriver.
# Build.Configuration must be set to 'Release' for UI tests to work.

parameters:
  platform: ''

jobs:
- job: UITests${{ parameters.platform }}
  displayName: UITests ${{ parameters.platform }}
  dependsOn: Package
  condition: succeeded()
  pool:
    vmImage: windows-2019
  steps:
  - checkout: none

  - powershell: Set-DisplayResolution -Width 1920 -Height 1080 -Force
    displayName: Set resolution to 1920x1080
    continueOnError: true

  - task: DownloadBuildArtifacts@0
    displayName: Download ${{ parameters.platform }} AppxBundle
    inputs:
      artifactName: drop
      itemPattern: drop/Release/${{ parameters.platform }}/Calculator/AppPackages/**

  - task: DownloadBuildArtifacts@0
    displayName: Download CalculatorUITests
    inputs:
      artifactName: drop
      itemPattern: drop/Release/${{ parameters.platform }}/CalculatorUITests/**

  #- task: PowerShell@1
  #  displayName: Install certificate
  #  inputs:
  #    scriptType: inlineScript
  #    arguments: '-NonInteractive -Verb RunAs'
  #    inlineScript: |  
  #     $file = ( Get-ChildItem -Path $(Build.ArtifactStagingDirectory)\AppxPackages\$(Calc.ArtifactsName)\Calculator_$(Calc.BuildVersion)_Test\Calculator_$(Calc.BuildVersion)_x86.cer )
  #     $file | Import-Certificate -CertStoreLocation cert:\LocalMachine\Root
  #  condition: succeededOrFailed()

  - task: PowerShell@2
    displayName: Install appx
    inputs:
      filePath: $(Build.ArtifactStagingDirectory)/drop/Release/${{ parameters.platform }}/Calculator/AppPackages/Calculator_$(Build.BuildNumber)_Test/Add-AppDevPackage.ps1
      arguments: -NonInteractive -CertificatePath $(Build.ArtifactStagingDirectory)/drop/Release/${{ parameters.platform }}/Calculator/AppPackages/Calculator_$(Build.BuildNumber)_Test/Calculator_$(Build.BuildNumber)_.cer -Force

  - powershell: Start-Process -FilePath "C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe" -Verb RunAs
    displayName: Start WinAppDriver

  - task: VSTest@2
    displayName: 'VsTest - Execute WinAppDriver Tests'
    inputs:
      testAssemblyVer2: |  
       $(Build.ArtifactStagingDirectory)\AppxPackages\$(Calc.ArtifactsName)\src\CalculatorWADTests\bin\$(Build.Configuration)\CalculatorTest.dll
       !**\obj\**
      vsTestVersion: 16.0
      runSettingsFile: src/CalculatorWADTests/TestSettings1.runsettings
      platform: '$(BuildPlatform)'
      configuration: '$(Build.Configuration)'
    continueOnError: true